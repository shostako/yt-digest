# 2025-12 作業ログ

## 2025-12-07 Renderデプロイ完了・YouTube URL直接処理への移行

### 実施内容

#### Renderデプロイ
- フロントエンド（Node.js）とバックエンド（Python）をRenderにデプロイ
- フロントエンドのRuntime設定ミス（Python3→Node）で作り直し
- 環境変数設定（GEMINI_API_KEY, YOUTUBE_API_KEY, NEXT_PUBLIC_API_URL）

#### youtube-transcript-api 問題
- **問題**: クラウドプロバイダー（Render）のIPがYouTubeにブロックされる
- **症状**: ローカルでは動くが、Renderデプロイ後に字幕取得失敗
- **原因**: YouTubeがボット対策でクラウドIPからのスクレイピングをブロック

#### 解決策: Gemini直接URL処理
- youtube-transcript-apiを廃止
- Gemini APIにYouTube URLを直接渡す方式に変更
- 参考: https://ai.google.dev/gemini-api/docs/video-understanding

#### Quota最適化
- **問題**: Pro→Flashフォールバックで2回リクエスト送信、Quota2倍消費
- **解決**: Flashモデルのみに変更、YouTube動画処理はトークン消費が大きいため

### 技術的発見
- Gemini APIはYouTube URLを`file_data.file_uri`で直接渡せる（プレビュー機能）
- YouTube動画処理は1日8時間分まで、現在無料
- 動画処理は字幕テキストより大量のトークンを消費する

### コミット履歴
```
8328f1e perf: YouTube動画処理はFlashのみに変更
856011c refactor: youtube-transcript-apiを廃止、Gemini直接URL処理に移行
84db03c chore: Render デプロイ設定追加
```

## 2025-12-08 Obsidian保存機能をURI scheme方式に変更

### 問題
- 「Obsidianに保存」ボタンがエラー: `Permission denied: '/mnt/c'`
- 原因: バックエンドがWSLパス（`/mnt/c/...`）でファイル保存しようとしていた
- Renderサーバー上には`/mnt/c`は存在しない（WSL環境専用のパス）

### 解決策
- バックエンドAPI保存方式を廃止
- Obsidian URI scheme（`obsidian://new`）方式に変更
- フロントエンド側で完結する実装

### 実装内容
- `obsidian://new?vault=...&file=...&content=...` 形式のURIを生成
- 設定項目を「Windowsパス」→「Vault名」+「フォルダパス」に変更
- フロントマター生成をフロントエンド側で実行

### 結果
- Obsidianが起動して新規ノートが即座に開かれる
- 以前の方式よりUXが向上（ファイル保存→手動で開く、が不要に）

### コミット履歴
```
15a270a feat: Obsidian URI scheme方式に変更
```

## 2025-12-08 コードレビュー改善（Issue #1）

### 実施内容

#### デッドコード削除
- `digest.py`: 198行 → 81行（-117行）
- 削除対象: SaveRequest/SaveResponse、windows_to_wsl_path、sanitize_filename、generate_frontmatter、/api/save エンドポイント
- 理由: Obsidian URI方式移行でサーバーサイド保存が不要に

#### CORS設定の本番対応
- `allow_origins=["*"]` → 環境変数 `FRONTEND_URL` で制御
- デフォルト: `http://localhost:3000`（ローカル開発用）
- Render環境変数: `FRONTEND_URL=https://yt-digest-web.onrender.com`

#### next/fontでGoogle Fonts読み込み
- `globals.css` の `@import url(...)` を廃止
- `layout.tsx` で `next/font/google` からフォント読み込み
- パフォーマンス向上（フォントの最適化・プリロード）

### スキップしたタスク
- **テスト追加**: 個人開発でROIが低い、必要時に追加
- **MODELS配列の定数化**: 将来のモデル追加に備えて配列維持

### 学び
- **Issue**: GitHubサーバー上に保存（ローカルにはない）
- **PR（Pull Request）**: チーム開発用、個人開発なら直接コミットでOK
- Issueはクローズしても履歴が残る（プロジェクトの記録として有用）

### コミット履歴
```
a1557ac docs: PROGRESS.md更新、Issue #1完了を記録
f3fdbd5 refactor: Issue #1 コードレビュー改善
```

## 2025-12-14 Render Blueprints移行 & 解説文途切れ問題修正

### Render Blueprints移行

#### 背景
- ダッシュボードで手動作成したサービスをBlueprint管理に移行
- render.yamlは既に存在していたが、Render側で適用されていなかった

#### 作業内容
1. render.yaml修正
   - `plan: free` を両サービスに明示
   - `FRONTEND_URL` 環境変数追加（バックエンドCORS用）
   - `PYTHON_VERSION` をパッチバージョン込みに修正（`3.11` → `3.11.0`）
     - Renderはmajor.minor.patch形式が必須
2. 既存サービス削除 → Blueprint作成 → 環境変数再設定

#### 学び
- Renderの`PYTHON_VERSION`は`3.11`ではダメ、`3.11.0`のようにパッチバージョンまで必要
- Blueprint移行時は既存サービス名と競合するため、先に削除が必要（URLは維持される）

### 解説文途切れ問題の修正

#### 問題
- 長い動画の解説が途中で打ち切られる

#### 原因
- `max_output_tokens=4096` の制限（日本語で約2000〜3000文字）

#### 解決
- `max_output_tokens` を `8192` に増加
- Gemini 2.5 Flashは最大65,536トークンまで対応なので余裕あり

### コミット履歴
```
4bd5dce fix: max_output_tokensを8192に増加
234ebb3 fix: PYTHON_VERSIONにパッチバージョン追加
8720d87 chore: render.yaml Blueprint対応強化
```

## 2025-12-14 音声読み上げ機能の実装と断念

### 試みた内容
- YouTube要約の解説テキストを音声で読み上げる機能を実装しようとした
- speak-itプロジェクトを参考に、Web Speech API（ブラウザ標準）を採用

### 実装した機能
- 再生/一時停止/停止ボタン
- 速度切替（1x / 1.2x）
- Markdown記号除去（stripMarkdown関数）
- 日本語音声の自動選択

### 発生した問題
- **現象**: 読み上げボタンを押しても音声が再生されない
- **デバッグ結果**: `speak()`は呼ばれているが、`onstart`コールバックが発火しない
- コンソールログでは正常に見える:
  - voicesCount: 32（音声リスト取得OK）
  - Selected voice: Google 日本語（音声選択OK）
  - Text length: 3374（テキスト取得OK）

### 試した対策
1. `voiceschanged`イベントで音声リストを非同期取得 → 効果なし
2. `cancel()`後に100ms待ってから`speak()` → 効果なし（自動再生ポリシーに引っかかった可能性）
3. `utterance`をuseRefで保持（GC対策） → 効果なし
4. `synth.speaking`の時だけ`cancel()`を呼ぶ → 効果なし

### 考察
- speak-itでは同じWeb Speech APIが正常動作している
- 違いはReact（Next.js）環境 vs Vanilla JS環境
- React環境特有の問題（レンダリングサイクル、state更新タイミング等）が原因の可能性

### 結論
- 原因特定に時間がかかりすぎるため断念
- 将来的にはspeak-itのAPIを呼び出す方式（Google Cloud TTS）も検討可能

### その他の修正
- Gemini APIレスポンス検証を追加（candidates/partsの存在確認、エラーメッセージ改善）

### コミット履歴
```
7e121b4 revert: 音声読み上げ機能を削除
29fe6c4 fix: Gemini APIレスポンス検証を追加
```
